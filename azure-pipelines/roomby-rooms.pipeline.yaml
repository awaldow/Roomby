name: Roomby.API.Rooms-$(Date:yyyyMMdd)$(Rev:.r)
trigger:
  branches:
    include:
    - master
  paths:
    include:
    - Roomby.API.Rooms

variables:
- name: buildConfiguration
  value: 'Release'
- name: projectPath
  value: '**/Roomby.API.Rooms.csproj'
- name: testProjectPath
  value: '**/Roomby.API.Rooms.[Tt]ests/*.csproj'

stages:
- stage: 'Build'
  displayName: 'Build the API'
  jobs: 
  - job: 'Build'
    displayName: 'Build job'
    pool:
      vmImage: 'windows-2019'
      demands:
      - npm

    steps:
    - task: NuGetToolInstaller@0
      displayName: 'Use NuGet 4.4.1'
      inputs:
        versionSpec: 4.4.1
    
    - task: UseDotNet@2
      displayName: 'Use .NET Core sdk 3.1.404'
      inputs:
        version: 3.1.404
    
    - task: DotNetCoreCLI@2
      displayName: 'dotnet restore'
      inputs:
        command: restore
        projects: '$(projectPath)'
    
    - task: DotNetCoreCLI@2
      displayName: 'dotnet build'
      inputs:
        projects: '$(projectPath)'
        arguments: '--configuration $(buildConfiguration)'
    
    - task: DotNetCoreCLI@2
      displayName: 'dotnet test'
      inputs:
        command: test
        projects: '$(testProjectPath)'
        arguments: '--configuration $(buildConfiguration)'
    
    - task: DotNetCoreCLI@2
      displayName: 'dotnet publish'
      inputs:
        command: publish
        publishWebProjects: false
        projects: '$(projectPath)'
        arguments: '--configuration $(buildConfiguration) --output $(build.artifactstagingdirectory)'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      inputs:
        PathtoPublish: '$(build.artifactstagingdirectory)'
      condition: succeededOrFailed()

- stage: 'Deploy'
  dependsOn: Build
  displayName: 'Deploy the API'
  jobs:
  - deployment: Test
    displayName: 'Test'
    environment: test
    variables:
    - group: Roomby Rooms API Secrets Test
    - name: ApplicationInsights.ConnectionString
      value: $(ApplicationInsights--ConnectionString)
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop
          - task: AzureRmWebAppDeployment@4
            displayName: 'Azure App Service Deploy: app-roomby-rooms-test'
            inputs:
              azureSubscription: 'Roomby Test'
              appType: webApp 
              WebAppName: app-roomby-rooms-test
              ResourceGroupName: rg-roomby-test
              packageForLinux: '$(Pipeline.Workspace)\drop\*.zip'
              
  - deployment: Prod
    displayName: 'Prod'
    environment: production
    variables:
      - group: Roomby Rooms API Secrets Prod
      - name: ApplicationInsights.ConnectionString
        value: $(ApplicationInsights--ConnectionString)
    dependsOn: Test
    condition: eq(1,2)
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop
          - task: AzureRmWebAppDeployment@4
            displayName: 'Azure App Service Deploy: app-roomby-rooms-prod staging slot'
            inputs:
              azureSubscription: 'Roomby Prod'
              WebAppName: app-roomby-rooms
              appType: webApp 
              deployToSlotOrASE: true
              ResourceGroupName: rg-roomby
              SlotName: app-roomby-rooms-staging
              packageForLinux: '$(Pipeline.Workspace)\drop\*.zip'
          - task: AzureAppServiceManage@0
            displayName: 'Swap Slots: app-roomby-rooms-prod'
            inputs:
              azureSubscription: 'Roomby Prod'
              WebAppName: app-roomby-rooms
              action: 'Swap Slots'
              ResourceGroupName: rg-roomby
              SourceSlot: app-roomby-rooms-staging
              SwapWithProduction: true
          